# üìß Integraci√≥n de Recuperaci√≥n de Contrase√±a con EmailJS

## ‚úÖ ACEPTACI√ìN

‚úîÔ∏è Puedes enviar un correo real usando EmailJS y recibirlo con el enlace  
‚úîÔ∏è El enlace abre la pantalla de reset con el token de la URL  
‚úîÔ∏è No hay dependencias rotas ni rutas cambiadas  
‚úîÔ∏è Los textos est√°n en espa√±ol y adaptados a SIDERPERU  
‚úîÔ∏è Todo funciona sin backend ni base de datos (solo demo)

---

## üìã Archivos Creados/Actualizados

### ‚ú® Archivos Nuevos

1. **`src/lib/emailConfig.ts`**
   - Archivo de configuraci√≥n centralizado con credenciales de EmailJS
   - Contiene Service ID, Template ID, Public Key
   - Incluye funci√≥n de validaci√≥n de configuraci√≥n

2. **`src/lib/email.ts`**
   - Helper reutilizable con funci√≥n `sendResetEmail()`
   - Maneja el env√≠o de correos a trav√©s de EmailJS
   - Incluye manejo de errores y logging
   - Documenta los par√°metros que deben coincidir con la plantilla

3. **`INTEGRACION_EMAILJS.md`** (este archivo)
   - Documentaci√≥n completa de la integraci√≥n
   - Instrucciones de uso y pruebas

### üîÑ Archivos Actualizados

4. **`src/pages/ForgotPasswordPage.tsx`**
   - Integraci√≥n con EmailJS real
   - Generaci√≥n de token mock para demo
   - Validaci√≥n de formato de email
   - Manejo de estados de carga
   - Mensajes neutros de seguridad

5. **`src/pages/ResetPasswordPage.tsx`**
   - Lectura y validaci√≥n de token desde URL query params
   - Pantalla de "enlace inv√°lido" si no hay token
   - Notas TODO para implementaci√≥n en producci√≥n
   - Aviso de que es demo sin backend

6. **`src/pages/EmailSentPage.tsx`**
   - Correcci√≥n de texto (eliminado comillas extras)

7. **`package.json`** (autom√°tico)
   - Dependencia `@emailjs/browser` a√±adida

---

## üîë Credenciales (ya configuradas)

Las credenciales ya est√°n configuradas en **`src/lib/emailConfig.ts`**:

```typescript
VITE_EMAILJS_SERVICE_ID = service_20s7oqj
VITE_EMAILJS_TEMPLATE_ID = template_0cv8moj
VITE_EMAILJS_PUBLIC_KEY = jal1IWZaTn2qRlNZx
VITE_APP_NAME = SIDERPERU
VITE_SUPPORT_EMAIL = kadudesposoriomendez@gmail.com
```

### ‚ö†Ô∏è Nota sobre Variables de Entorno

Lovable **no soporta** variables de entorno con prefijo `VITE_*` en archivos `.env`. Por eso usamos un archivo de configuraci√≥n TypeScript (`emailConfig.ts`).

Si necesitas cambiar las credenciales, edita directamente `src/lib/emailConfig.ts`.

---

## üìù Snippets Clave

### 1. `src/lib/email.ts` - Funci√≥n de env√≠o

```typescript
export const sendResetEmail = async (
  toEmail: string,
  resetLink: string
): Promise<void> => {
  if (!validateEmailConfig()) {
    throw new Error("Configuraci√≥n de EmailJS incompleta");
  }

  const { serviceId, templateId, publicKey, appName, supportEmail } = emailConfig;

  const templateParams = {
    to_email: toEmail,
    reset_link: resetLink,
    app_name: appName,
    support_email: supportEmail
  };

  const response = await emailjs.send(
    serviceId,
    templateId,
    templateParams,
    { publicKey }
  );
};
```

### 2. `src/pages/ForgotPasswordPage.tsx` - Submit handler

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showToast("error", "Por favor ingresa un correo electr√≥nico v√°lido");
    return;
  }

  setIsLoading(true);

  try {
    // Generar token mock para demo
    const token = crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
    const resetLink = `${window.location.origin}/reset-password?token=${token}`;

    // Enviar email real con EmailJS
    await sendResetEmail(email, resetLink);

    showToast("success", "Si el correo existe, te enviaremos un enlace");
    navigate("/email-sent");
  } catch (error) {
    showToast("error", "No pudimos enviar el correo, intenta de nuevo");
  } finally {
    setIsLoading(false);
  }
};
```

### 3. `src/pages/ResetPasswordPage.tsx` - Validaci√≥n de token

```typescript
const [searchParams] = useSearchParams();
const [token, setToken] = useState<string | null>(null);
const [isValidToken, setIsValidToken] = useState(true);

useEffect(() => {
  const urlToken = searchParams.get("token");
  
  if (!urlToken) {
    setIsValidToken(false);
    return;
  }

  setToken(urlToken);
  setIsValidToken(true); // Demo: acepta cualquier token
}, [searchParams]);

// Si no es v√°lido, mostrar pantalla de error
if (!isValidToken) {
  return <InvalidTokenScreen />;
}
```

---

## üß™ Instrucciones de Prueba (QA)

### ‚úÖ Caso Feliz

1. **Ir a `/login`**
   - Hacer clic en "¬øHas olvidado tu contrase√±a?"

2. **En `/forgot-password`**
   - Ingresar un correo v√°lido: `kadudesposoriomendez@gmail.com`
   - Clic en "Enviar enlace de recuperaci√≥n"
   - Ver toast: "Si el correo existe, te enviaremos un enlace..."

3. **Revisar email**
   - Abrir el correo recibido de EmailJS
   - Verificar que tenga el logo de SIDERPERU
   - Verificar que el enlace tenga el formato correcto
   - Hacer clic en el enlace

4. **En `/reset-password?token=XXXX`**
   - Ingresar nueva contrase√±a que cumpla requisitos
   - Confirmar contrase√±a
   - Ver indicadores verdes de requisitos cumplidos
   - Clic en "Actualizar contrase√±a"
   - Ver mensaje de √©xito
   - Ser redirigido a `/login`

### ‚ùå Casos de Error

1. **Email inv√°lido**
   - En `/forgot-password`, ingresar "correo-invalido"
   - Intentar enviar ‚Üí Ver error de validaci√≥n

2. **Sin conexi√≥n**
   - Desactivar internet
   - Intentar enviar desde `/forgot-password`
   - Ver toast: "No pudimos enviar el correo..."

3. **Token inv√°lido**
   - Abrir manualmente `/reset-password` (sin `?token=`)
   - Ver pantalla de "Enlace inv√°lido o expirado"
   - Ver bot√≥n "Ir a inicio de sesi√≥n"

4. **Contrase√±as no coinciden**
   - En `/reset-password?token=123`, ingresar contrase√±as diferentes
   - El bot√≥n debe estar deshabilitado
   - Ver requisito de coincidencia en rojo

---

## üöÄ Comandos para Correr Localmente

```bash
# Instalar dependencias (si es necesario)
npm install

# Iniciar servidor de desarrollo
npm run dev

# Abrir navegador en
http://localhost:5173/login
```

---

## üîê Notas de Seguridad (Producci√≥n)

Este sistema es **SOLO PARA DEMO**. Para producci√≥n necesitas:

### Backend Requerido

1. **Generaci√≥n de tokens seguros**
   ```javascript
   // Node.js ejemplo
   const crypto = require('crypto');
   const token = crypto.randomBytes(32).toString('hex');
   const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 min
   
   await db.resetTokens.create({
     token,
     email,
     expiresAt,
     used: false
   });
   ```

2. **Endpoint de validaci√≥n**
   ```javascript
   // GET /api/validate-reset-token?token=xxx
   const tokenRecord = await db.resetTokens.findOne({ token });
   
   if (!tokenRecord || tokenRecord.used || Date.now() > tokenRecord.expiresAt) {
     return res.status(400).json({ valid: false });
   }
   
   return res.json({ valid: true });
   ```

3. **Endpoint de actualizaci√≥n de contrase√±a**
   ```javascript
   // POST /api/reset-password
   const { token, newPassword } = req.body;
   
   // 1. Validar token
   const tokenRecord = await db.resetTokens.findOne({ token, used: false });
   if (!tokenRecord) throw new Error('Token inv√°lido');
   
   // 2. Hashear contrase√±a
   const hashedPassword = await bcrypt.hash(newPassword, 10);
   
   // 3. Actualizar en BD
   await db.users.updateOne(
     { email: tokenRecord.email },
     { password: hashedPassword }
   );
   
   // 4. Marcar token como usado
   await db.resetTokens.updateOne({ token }, { used: true });
   ```

4. **Rate Limiting**
   - Limitar a 3 solicitudes por IP por hora
   - Usar librer√≠as como `express-rate-limit`

---

## üìå Configuraci√≥n de Plantilla EmailJS

Para que funcione, tu plantilla en EmailJS debe tener estas variables:

```
{{to_email}}       ‚Üí Email del destinatario
{{reset_link}}     ‚Üí URL completa con token
{{app_name}}       ‚Üí "SIDERPERU"
{{support_email}}  ‚Üí "kadudesposoriomendez@gmail.com"
```

**Ejemplo de plantilla HTML:**

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .button { 
      background: #1f2937; 
      color: white; 
      padding: 12px 24px; 
      text-decoration: none;
      border-radius: 8px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{app_name}} - Recuperaci√≥n de Contrase√±a</h1>
    
    <p>Has solicitado restablecer tu contrase√±a.</p>
    
    <p>Haz clic en el siguiente bot√≥n para crear una nueva contrase√±a:</p>
    
    <a href="{{reset_link}}" class="button">
      Restablecer Contrase√±a
    </a>
    
    <p><small>Este enlace expira en 5 minutos por seguridad.</small></p>
    
    <p>Si no solicitaste este cambio, ignora este correo.</p>
    
    <hr>
    
    <p><small>Equipo de {{app_name}}<br>
    Soporte: {{support_email}}</small></p>
  </div>
</body>
</html>
```

---

## ‚úÖ Confirmaci√≥n Final

### ‚úîÔ∏è NO se removi√≥/rompi√≥ nada existente

- ‚úÖ Rutas existentes intactas (`/login`, `/dashboard`, `/planos`, etc.)
- ‚úÖ Componentes existentes funcionando
- ‚úÖ Estilos Tailwind mantenidos
- ‚úÖ Sistema de autenticaci√≥n demo intacto
- ‚úÖ Tema oscuro/claro funcional

### ‚úîÔ∏è Solo se agreg√≥/mejor√≥

- ‚úÖ Integraci√≥n real con EmailJS
- ‚úÖ Validaci√≥n de token en URL
- ‚úÖ Pantalla de error para tokens inv√°lidos
- ‚úÖ Mejores mensajes de error
- ‚úÖ Validaci√≥n de formato de email
- ‚úÖ Accesibilidad (`aria-busy`)
- ‚úÖ Notas TODO para producci√≥n

---

## üéØ Resumen Ejecutivo

**¬øQu√© funciona ahora?**
- ‚úÖ Env√≠o REAL de emails con EmailJS
- ‚úÖ Enlaces con tokens en la URL
- ‚úÖ Validaci√≥n de tokens
- ‚úÖ Formulario de nueva contrase√±a
- ‚úÖ Redirecci√≥n a login tras √©xito

**¬øQu√© falta para producci√≥n?**
- ‚ùå Backend para generar tokens seguros
- ‚ùå Base de datos para tokens
- ‚ùå Validaci√≥n de expiraci√≥n (5 min)
- ‚ùå Hash de contrase√±as
- ‚ùå Rate limiting

**¬øListo para demo?**
- ‚úÖ S√ç - Funciona completamente para demostraciones
- ‚úÖ Los usuarios pueden probar el flujo completo
- ‚úÖ Se env√≠an correos reales
- ‚úÖ La UX es profesional y pulida

---

## üìû Soporte

Si tienes problemas:

1. **Verificar credenciales** en `src/lib/emailConfig.ts`
2. **Revisar consola** del navegador para errores
3. **Comprobar cuenta EmailJS**:
   - Service ID correcto
   - Template ID correcto
   - Public Key activa
   - Dominio autorizado en EmailJS
4. **Verificar plantilla** tenga las 4 variables requeridas

---

**üéâ ¬°Integraci√≥n completada con √©xito!**
